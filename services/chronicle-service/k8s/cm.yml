apiVersion: v1
kind: ConfigMap
metadata:
  name: chronicle-service-scripts
  namespace: dsm
data:
  app.py: |
    from fastapi import FastAPI, HTTPException, status
    from pydantic import BaseModel
    from typing import List, Optional
    import uuid
    import psycopg2
    from psycopg2.extras import RealDictCursor
    import structlog
    import datetime

    from utils import get_db_connection

    logger = structlog.get_logger(__name__)

    app = FastAPI()

    # --- Pydantic Models ---
    class DailyScrumReportNote(BaseModel):
        project_id: str
        sprint_id: str
        report_date: datetime.date
        employee_id: str
        yesterday_work: str
        today_work: str
        impediments: str

    class SprintPlanningNote(BaseModel):
        project_id: str
        sprint_id: str
        sprint_goal: str
        planned_tasks: List[str]

    class ActionItem(BaseModel):
        description: str
        status: str = "open"

    class SprintRetrospectiveNote(BaseModel):
        sprint_id: str
        project_id: str
        what_went_well: Optional[str] = None
        what_could_be_improved: Optional[str] = None
        action_items: List[ActionItem] = []
        facilitator_id: Optional[str] = None
        attendees: List[str] = []

    # --- API Endpoints ---
    @app.get("/health")
    def health_check():
        return {"status": "ok"}

    @app.post("/notes/daily_scrum_report", status_code=status.HTTP_201_CREATED)
    def record_daily_scrum_report(note: DailyScrumReportNote):
        conn = None
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            note_id = uuid.uuid4()
            cursor.execute(
                """
                INSERT INTO chronicle_notes (
                    id, event_type, project_id, sprint_id, report_date, 
                    employee_id, yesterday_work, today_work, impediments
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                """,
                (
                    str(note_id), "daily_scrum_report", note.project_id, note.sprint_id,
                    note.report_date, note.employee_id, note.yesterday_work,
                    note.today_work, note.impediments
                )
            )
            conn.commit()
            cursor.close()
            logger.info("Daily scrum report recorded", note_id=str(note_id), project_id=note.project_id)
            return {"message": "Daily scrum report recorded successfully", "note_id": note_id}
        except psycopg2.Error as e:
            logger.error("Database error recording daily scrum report", error=str(e))
            if conn: conn.rollback()
            raise HTTPException(status_code=500, detail=f"Database error: {e}")
        finally:
            if conn: conn.close()

    @app.post("/notes/sprint_planning", status_code=status.HTTP_201_CREATED)
    def record_sprint_planning_note(note: SprintPlanningNote):
        conn = None
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            note_id = uuid.uuid4()
            note_content = f"Goal: {note.sprint_goal}\nPlanned Tasks: {', '.join(note.planned_tasks)}"
            cursor.execute(
                "INSERT INTO chronicle_notes (id, event_type, project_id, sprint_id, note_content) VALUES (%s, %s, %s, %s, %s)",
                (str(note_id), "sprint_planning", note.project_id, note.sprint_id, note_content)
            )
            conn.commit()
            cursor.close()
            logger.info("Sprint planning note recorded", note_id=str(note_id), project_id=note.project_id)
            return {"message": "Sprint planning note recorded successfully", "note_id": note_id}
        except psycopg2.Error as e:
            logger.error("Database error recording sprint planning note", error=str(e))
            if conn: conn.rollback()
            raise HTTPException(status_code=500, detail=f"Database error: {e}")
        finally:
            if conn: conn.close()

    @app.post("/notes/sprint_retrospective", status_code=status.HTTP_201_CREATED)
    def record_sprint_retrospective_note(note: SprintRetrospectiveNote):
        conn = None
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # Insert into sprint_retrospectives table
            retrospective_id = uuid.uuid4()
            cursor.execute(
                """
                INSERT INTO sprint_retrospectives (
                    id, sprint_id, project_id, what_went_well, what_could_be_improved, facilitator_id
                ) VALUES (%s, %s, %s, %s, %s, %s)
                """,
                (
                    str(retrospective_id), note.sprint_id, note.project_id, 
                    note.what_went_well, note.what_could_be_improved, note.facilitator_id
                )
            )
            
            # Insert action items
            for item in note.action_items:
                cursor.execute(
                    """
                    INSERT INTO retrospective_action_items (retrospective_id, description, status)
                    VALUES (%s, %s, %s)
                    """,
                    (str(retrospective_id), item.description, item.status)
                )
                
            # Insert attendees
            for employee_id in note.attendees:
                cursor.execute(
                    """
                    INSERT INTO retrospective_attendees (retrospective_id, employee_id)
                    VALUES (%s, %s)
                    """,
                    (str(retrospective_id), employee_id)
                )
                
            conn.commit()
            cursor.close()
            logger.info("Sprint retrospective recorded", retrospective_id=str(retrospective_id), sprint_id=note.sprint_id)
            return {"message": "Sprint retrospective recorded successfully", "retrospective_id": retrospective_id}
        except psycopg2.Error as e:
            logger.error("Database error recording sprint retrospective", error=str(e))
            if conn: conn.rollback()
            raise HTTPException(status_code=500, detail=f"Database error: {e}")
        finally:
            if conn: conn.close()

    @app.get("/notes/daily_scrum_report", status_code=status.HTTP_200_OK)
def get_daily_scrum_reports(sprint_id: Optional[str] = None, project_id: Optional[str] = None):
        conn = None
        try:
            conn = get_db_connection()
            cursor = conn.cursor(cursor_factory=RealDictCursor)
            
            query = "SELECT * FROM chronicle_notes WHERE event_type = 'daily_scrum_report'"
            params = []
            
            if sprint_id:
                query += " AND sprint_id = %s"
                params.append(sprint_id)
            
            if project_id:
                query += " AND project_id = %s"
                params.append(project_id)
                
            query += " ORDER BY report_date DESC"
            
            cursor.execute(query, tuple(params))
            reports = cursor.fetchall()
            cursor.close()
            
            logger.info("Fetched daily scrum reports", sprint_id=sprint_id, project_id=project_id, count=len(reports))
            
            if not reports:
                raise HTTPException(status_code=404, detail="No daily scrum reports found for the given criteria.")
                
            return reports
            
        except psycopg2.Error as e:
            logger.error("Database error fetching daily scrum reports", error=str(e))
            raise HTTPException(status_code=500, detail=f"Database error: {e}")
        finally:
            if conn: conn.close()

    @app.get("/notes/sprint_retrospective", status_code=status.HTTP_200_OK)
def get_sprint_retrospective_notes(sprint_id: Optional[str] = None, project_id: Optional[str] = None):
        conn = None
        try:
            conn = get_db_connection()
            cursor = conn.cursor(cursor_factory=RealDictCursor)
            
            query = """
                SELECT
                    sr.id as retrospective_id,
                    sr.sprint_id,
                    sr.project_id,
                    sr.what_went_well,
                    sr.what_could_be_improved,
                    sr.facilitator_id,
                    sr.created_at,
                    ARRAY_AGG(DISTINCT rai.description || '::' || rai.status) FILTER (WHERE rai.id IS NOT NULL) as action_items_raw,
                    ARRAY_AGG(DISTINCT ra.employee_id) FILTER (WHERE ra.employee_id IS NOT NULL) as attendees
                FROM sprint_retrospectives sr
                LEFT JOIN retrospective_action_items rai ON sr.id = rai.retrospective_id
                LEFT JOIN retrospective_attendees ra ON sr.id = ra.retrospective_id
                WHERE 1=1
            """
            params = []
            
            if sprint_id:
                query += " AND sr.sprint_id = %s"
                params.append(sprint_id)
            
            if project_id:
                query += " AND sr.project_id = %s"
                params.append(project_id)
                
            query += " GROUP BY sr.id ORDER BY sr.created_at DESC"
            
            cursor.execute(query, tuple(params))
            reports_raw = cursor.fetchall()
            cursor.close()
            
            if not reports_raw:
                raise HTTPException(status_code=404, detail="No sprint retrospective notes found for the given criteria.")
                
            reports = []
            for r in reports_raw:
                action_items = []
                if r['action_items_raw']:
                    for item_str in r['action_items_raw']:
                        desc, status_val = item_str.split('::')
                        action_items.append({"description": desc, "status": status_val})
                
                reports.append({
                    "retrospective_id": str(r['retrospective_id']),
                    "sprint_id": r['sprint_id'],
                    "project_id": r['project_id'],
                    "what_went_well": r['what_went_well'],
                    "what_could_be_improved": r['what_could_be_improved'],
                    "action_items": action_items,
                    "facilitator_id": r['facilitator_id'],
                    "attendees": r['attendees'] if r['attendees'] else [],
                    "created_at": r['created_at'].isoformat()
                })
            
            logger.info("Fetched sprint retrospective notes", sprint_id=sprint_id, project_id=project_id, count=len(reports))
            
            return reports
            
        except psycopg2.Error as e:
            logger.error("Database error fetching sprint retrospective notes", error=str(e))
            raise HTTPException(status_code=500, detail=f"Database error: {e}")
        finally:
            if conn: conn.close()
  utils.py: |
    import os
    import psycopg2
    import structlog
    from fastapi import HTTPException

    logger = structlog.get_logger(__name__)

    def get_db_connection():
        try:
            db_host = os.getenv("POSTGRES_HOST", "postgres")
            db_name = os.getenv("POSTGRES_DB")
            db_user = os.getenv("POSTGRES_USER")
            db_password = os.getenv("POSTGRES_PASSWORD")

            logger.info("Attempting to connect to database.")
            conn = psycopg2.connect(
                host=db_host,
                database=db_name,
                user=db_user,
                password=db_password
            )
            logger.info("Database connection successful.")
            return conn
        except psycopg2.OperationalError as e:
            logger.error("Database connection failed.", error=str(e))
            raise HTTPException(status_code=500, detail=f"Database connection failed: {e}")
  requirements.txt: |
    fastapi
    uvicorn
    psycopg2-binary
    structlog
