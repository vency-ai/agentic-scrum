apiVersion: v1
kind: ConfigMap
metadata:
  name: project-service-scripts
  namespace: dsm
data:
  app.py: |
    from fastapi import FastAPI, HTTPException
    from pydantic import BaseModel
    import structlog
    import psycopg2

    from utils import get_db_connection

    # Configure logging
    logger = structlog.get_logger()

    app = FastAPI()

    # Pydantic model for data validation
    class Project(BaseModel):
        id: str
        name: str
        description: str
        status: str

    class ProjectStatus(BaseModel):
        status: str

    @app.get("/health", status_code=200)
    def health_check():
        """Health check endpoint to verify service is running."""
        return {"status": "ok"}

    @app.post("/projects", status_code=201)
    def create_project(project: Project):
        """
        Creates a new project in the database.
        """
        logger.info("Received request to create project", project_id=project.id)
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()

            cur.execute(
                "INSERT INTO projects (prjid, projectname, codename, status) VALUES (%s, %s, %s, %s)",
                (project.id, project.name, project.description, project.status)
            )

            conn.commit()
            cur.close()
            logger.info("Successfully created project", project_id=project.id)
            return {"message": "Project created successfully", "project_id": project.id}

        except (Exception, psycopg2.DatabaseError) as error:
            logger.error("Database error while creating project", error=str(error))
            if conn:
                conn.rollback()
            raise HTTPException(status_code=500, detail="Database operation failed.")

        finally:
            if conn:
                conn.close()
                logger.info("Database connection closed.")

    @app.get("/projects", status_code=200)
    def list_projects():
        """
        Retrieves a list of all projects from the database.
        """
        logger.info("Received request to list all projects")
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()

            cur.execute("SELECT prjid, projectname, codename, status FROM projects")
            projects_data = cur.fetchall()
            cur.close()

            projects_list = []
            for prjid, projectname, codename, status in projects_data:
                projects_list.append(Project(id=prjid, name=projectname, description=codename, status=status))

            logger.info("Successfully retrieved all projects", count=len(projects_list))
            return projects_list

        except (Exception, psycopg2.DatabaseError) as error:
            logger.error("Database error while listing projects", error=str(error))
            if conn:
                conn.rollback()
            raise HTTPException(status_code=500, detail="Database operation failed.")

        finally:
            if conn:
                conn.close()
                logger.info("Database connection closed.")

    @app.get("/projects/{project_id}", status_code=200, response_model=Project)
    def get_project(project_id: str):
        """
        Retrieves details for a single project by its ID.
        """
        logger.info("Received request to get project details", project_id=project_id)
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()

            query = "SELECT prjid, projectname, codename, status FROM projects WHERE prjid = %s"
            logger.info("Executing query", query=query, params=(project_id,))
            cur.execute(query, (project_id,))
            project_data = cur.fetchone()
            logger.info("Raw query result", result=project_data)
            
            if not project_data:
                cur.close()
                raise HTTPException(status_code=404, detail=f"Project {project_id} not found.")

            prjid, projectname, codename, status = project_data
            project = Project(id=prjid.strip(), name=projectname.strip(), description=codename.strip(), status=status.strip())
            logger.info("Successfully retrieved project details", project_id=project.id)
            
            cur.close()
            return project
        except HTTPException:
            raise
        except (Exception, psycopg2.DatabaseError) as error:
            logger.error("Database error while retrieving project details", error=str(error))
            if conn:
                conn.rollback()
            raise HTTPException(status_code=500, detail="Database operation failed.")
        finally:
            if conn:
                conn.close()
                logger.info("Database connection closed.")

    @app.put("/projects/{project_id}/status", status_code=200)
    def update_project_status(project_id: str, status: ProjectStatus):
        """
        Updates the status of a project.
        """
        logger.info("Received request to update project status", project_id=project_id, status=status.status)
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()

            cur.execute(
                "UPDATE projects SET status = %s WHERE prjid = %s",
                (status.status, project_id)
            )

            if cur.rowcount == 0:
                raise HTTPException(status_code=404, detail=f"Project {project_id} not found.")

            conn.commit()
            cur.close()
            logger.info("Successfully updated project status", project_id=project_id, status=status.status)
            return {"message": "Project status updated successfully", "project_id": project_id, "status": status.status}

        except (Exception, psycopg2.DatabaseError) as error:
            logger.error("Database error while updating project status", error=str(error))
            if conn:
                conn.rollback()
            raise HTTPException(status_code=500, detail="Database operation failed.")

        finally:
            if conn:
                conn.close()
                logger.info("Database connection closed.")

    @app.get("/projects/{project_id}/team-members", status_code=200)
    def get_project_team_members(project_id: str):
        """
        Retrieves team members associated with a specific project.
        """
        logger.info("Received request to get team members for project", project_id=project_id)
        conn = None
        try:
            conn = get_db_connection()
            cur = conn.cursor()

            cur.execute(
                """
                SELECT t.id, t.name, t.gender, t.state, t.age
                FROM teams t
                JOIN project_team_mapping ptm ON t.id = ptm.employee_id
                WHERE ptm.project_id = %s
                """,
                (project_id,)
            )
            team_members = []
            for row in cur.fetchall():
                team_members.append({
                    "id": row[0],
                    "name": row[1],
                    "gender": row[2],
                    "state": row[3],
                    "age": row[4]
                })

            cur.close()
            logger.info("Successfully retrieved team members for project", project_id=project_id, count=len(team_members))
            return {"project_id": project_id, "team_members": team_members}

        except (Exception, psycopg2.DatabaseError) as error:
            logger.error("Database error while retrieving team members", error=str(error))
            if conn:
                conn.rollback()
            raise HTTPException(status_code=500, detail="Database operation failed.")

        finally:
            if conn:
                conn.close()
                logger.info("Database connection closed.")
  utils.py: |
    import os
    import psycopg2
    import structlog

    # Configure a simple logger for the utility module
    logger = structlog.get_logger(__name__)

    def get_db_connection():
        """
        Establishes a connection to the PostgreSQL database using credentials
        from environment variables.
        """
        try:
            db_host = os.getenv("POSTGRES_HOST", "postgres")
            db_name = os.getenv("POSTGRES_DB")
            db_user = os.getenv("POSTGRES_USER")
            db_password = os.getenv("POSTGRES_PASSWORD")

            logger.info("Attempting to connect to database...")

            conn = psycopg2.connect(
                host=db_host,
                database=db_name,
                user=db_user,
                password=db_password
            )
            logger.info("Database connection successful.")
            return conn
        except psycopg2.OperationalError as e:
            logger.error("Database connection failed.", error=str(e))
            raise